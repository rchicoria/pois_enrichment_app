
<% @pois_thumbs = [ [], [], [], [] ] %>
<% @i = 0 %>
<% @pois.each do |poi| %>
	<% @pois_thumbs[@i] << poi %>
	<% @i = (@i + 1) % 4 %>
<% end %>

<div class="container" id="c_poi" style="display: none">
	<span id="pos_y" style="display: none"></span>
	<a onclick="hide_poi(); return false;" style="cursor: pointer">Voltar à lista</a>
	<div class="row">
		<div class="span12">
			<ul class="thumbnails">
				<li class="thumbnail span12 thumb_poi">
					<div class="row">
						<div class="popup-title span12" style="padding: 10px"><h3></h3></div>
					</div>
					<div class="row">
						<div class="popup-pic span3" style="padding: 10px"></div>
						<div class="popup-text span8" style="padding: 10px"></div>
					</div>
				</li>
			</ul>
		</div>
	</div>
</div>

<div class="container" id="c_list">
	<div class="row">
		<% @pois_thumbs.each do |col| %>
			<% if col != nil || col.length > 0 %>
				<div class="span3">
					<ul class="thumbnails grid">
						<% col.each do |poi| %>
							<li class="thumbnail span3">
								<a href="#" onclick="show_poi(<%= poi.id %>); return false;">
									<% if poi.url_imagem  %>
										<% if poi.url_imagem.length > 0 %>
											<img src="<%= poi.url_imagem %>" width="100%" style="max-height: 250px" alt="">
										<% end %>
									<% end %>
								</a>
								<div class="caption">
									<h4 onclick="show_poi(<%= poi.id %>); return false;" style="cursor: pointer">
										<%= poi.nome %>
									</h4>
									<p><%= poi.descricao %></p>
								</div>
							</li>
						<% end %>
					</ul>
				</div>
			<% end %>
		<% end %>
	</div>
	<div class="modal hide" id="myModal" style="width: 95%; max-width: 530px; max-height: 80%">
		<div class="modal-header">
		    <button type="button" class="close" data-dismiss="modal">×</button>
		    <h3></h3>
		</div>
		<div class="modal-tabs" style="background: #fafafa">
			<ul class="nav nav-tabs">
				<li id="tab-informacoes"><a style="cursor: pointer" onclick="select_informacoes(); return false;">Informações</a></li>
				<li id="tab-localizacao"><a style="cursor: pointer" onclick="select_localizacao(); return false;">Localização</a></li>
			</ul>
		</div>
		<div class="modal-body" style="overflow: hidden">
			<div id="modal-informacoes"></div>
			<div id="modal-localizacao"></div>
		</div>
		<div class="modal-footer">
		    <a href="#" class="btn" data-dismiss="modal">Close</a>
		    <a href="#" class="btn btn-primary">Save changes</a>
		</div>
	</div>

	<script>
		var map;
		var lat = 0;
		var lng = 0;

		function select_informacoes() {
			$('#modal-informacoes').show();
			$('#modal-localizacao').hide();
			$('#tab-informacoes').attr('class', 'active');
			$('#tab-localizacao').attr('class', '');
		}

		function select_localizacao() {
			$('#modal-informacoes').hide();
			$('#modal-localizacao').show();
			$('#tab-informacoes').attr('class', '');
			$('#tab-localizacao').attr('class', 'active');

			google.maps.event.trigger(mapa, 'resize');
			map = new GMaps({
				div: '#mapa',
				lat: lat,
				lng: lng
			}).addMarker({
				lat: lat,
				lng: lng
			});
		}
		
		function show_poi(id) {
			$('#c_poi .popup-title h3').append('&nbsp;');
			var pos_y = $(document).scrollTop();
			$('#c_list').hide();
			$('#c_poi').show();
			
			var jqxhr = $.getJSON("/pois/"+id+".json", function() {
				var r = JSON.parse(jqxhr.responseText);
				$('#c_poi .popup-title h3').text(r.local.nome);
				
				// Esquerda
				if (r.local.url_imagem) $('#c_poi .popup-pic').append("<p><img src='"+r.local.url_imagem+"' width='95%' /></p>");
				if(r.local.website) $('#c_poi .popup-pic').append('<p><a target="_blank" href="'+r.local.website+'">Website</a></p>');
				if(r.local.telefone) $('#c_poi .popup-pic').append('<p>'+r.local.telefone+'</p>');
				if(r.local.descricao) $('#c_poi .popup-pic').append('<p>'+r.local.descricao+'</p>');
				
				// Direita
				// Mapa
				var localizacao = "";
				localizacao += "<div id='mapa'></div>"
				localizacao += "<p>Marque no seu GPS:</p><p><b>Latitude:</b> "+r.local.lat+"<br /><b>Longitude:</b> "+r.local.lng+"</p><hr />";
				$('#c_poi .popup-text').append(localizacao);
				lat = r.local.lat;
				lng = r.local.lng;
				map = new GMaps({
					div: '#mapa',
					lat: lat,
					lng: lng
				});
				$("#mapa").css("width", "100%").css("height", 250);
				google.maps.event.trigger(mapa, 'resize');
				map = new GMaps({
					div: '#mapa',
					lat: lat,
					lng: lng
				}).addMarker({
					lat: lat,
					lng: lng
				});
				
				// Metadata
				if(r.local.tipo_restaurante) $('#c_poi .popup-text').append('<p><b>Tipo de restaurante:</b> '+r.local.tipo_restaurante+'</p>');
				if(r.local.tipo_musica) $('#c_poi .popup-text').append('<p><b>Tipo de música:</b> '+r.local.tipo_musica+'</p>');
				if(r.local.especialidades) $('#c_poi .popup-text').append('<p><b>Especialidades:</b> '+r.local.especialidades+'</p>');
				if(r.local.preco_medio) $('#c_poi .popup-text').append('<p><b>Preço médio:</b> '+r.local.preco_medio+'</p>');
				if(r.local.lotacao) $('#c_poi .popup-text').append('<p><b>Lotação:</b> '+r.local.lotacao+'</p>');
				if(r.local.ano_construcao) $('#c_poi .popup-text').append('<p><b>Data de construção:</b> '+r.local.ano_construcao+'</p>');
				if(r.local.servicos_cultura) $('#c_poi .popup-text').append('<p><b>Serviços disponíveis:</b> '+r.local.servicos_cultura+'</p>');
				if(r.local.horario) $('#c_poi .popup-text').append('<p><b>Horário de funcionamento:</b> '+r.local.horario+'</p>');
				if (r.servicos.length > 0) {
					var informacoes = "<p>Serviços disponíveis:</p><ul>";
					for (var i in r.servicos) {
						informacoes += "<li>"+r.servicos[i].nome+"</li>";
					}
					informacoes += "</ul>"
					$('#c_poi .popup-text').append(informacoes);
				}
			});
			
			$('#pos_y').text(pos_y);
			$(document).scrollTop(0);
		}
		
		function hide_poi() {
		var pos_y = parseInt($('#pos_y').text());
			$('#c_poi').hide();
			$('#c_poi .popup-title h3').text('');
			$('#c_poi .popup-pic').text('');
			$('#c_poi .popup-text').text('');
			$('#c_list').show();
			$(document).scrollTop(pos_y);
		}

		function show_modal(id) {
			$('#myModal h3').text('');
			$('#myModal h3').append('&nbsp;');
			$('#modal-informacoes').text('');
			$('#modal-informacoes').append('<p align="center" style="margin-top: 20px"><img src="http://www.animale.com.br/wp-content/themes/animale2013/images/loading.gif" width="20"></p>');
			$('#modal-localizacao').text('');
			select_informacoes();
			$('#myModal').modal('show');
			var jqxhr = $.getJSON("/pois/"+id+".json", function() {
				var r = JSON.parse(jqxhr.responseText);
				$('#myModal h3').text(r.local.nome);

				// Informacoes
				var informacoes = "";
				if (r.local.url_imagem) informacoes += "<p><img src='"+r.local.url_imagem+"'></p>";
				/*if (r.local.bandeira_azul) informacoes += "<p>Esta praia tem bandeira azul.</p>";
				else informacoes += "<p>Esta praia não tem bandeira azul.</p>";
				if (r.servicos.length > 0) {
					informacoes += "<p>Serviços disponíveis:</p><ul>";
					for (var i in r.servicos) {
						informacoes += "<li>"+r.servicos[i].nome+"</li>";
					}
					informacoes += "</ul>"
				}*/
				$('#modal-informacoes').text('');
				$('#modal-informacoes').append(informacoes);

				// Localizacao
				var localizacao = "";
				localizacao += "<div id='mapa'></div>"
				localizacao += "<p>Marque no seu GPS:</p><p><b>Latitude:</b> "+r.local.lat+"<br /><b>Longitude:</b> "+r.local.lng+"</p>";
				$('#modal-localizacao').append(localizacao);
				lat = r.local.lat;
				lng = r.local.lng;
				map = new GMaps({
					div: '#mapa',
					lat: lat,
					lng: lng
				});
				$("#mapa").css("width", "100%").css("height", 250);
			})
			.error(function() { console.log(jqxhr); });
		}
	</script>
</div>
